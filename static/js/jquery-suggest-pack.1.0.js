(function($){$.event.special.textchange={setup:function(data,namespaces){$(this).attr('lastValue',this.contentEditable==='true'?$(this).html():$(this).val());$(this).bind('keyup.textchange',$.event.special.textchange.handler);$(this).bind('cut.textchange paste.textchange input.textchange',$.event.special.textchange.delayedHandler)},teardown:function(namespaces){$(this).unbind('.textchange')},handler:function(event){$.event.special.textchange.triggerIfChanged($(this))},delayedHandler:function(event){var element=$(this);setTimeout(function(){$.event.special.textchange.triggerIfChanged(element)},25)},triggerIfChanged:function(element){var current=element[0].contentEditable==='true'?element.html():element.val();if(current!==element.attr('lastValue')){element.trigger('textchange',element.attr('lastValue'),current).attr('lastValue',current)}}};$.fn.suggest=function(c){c=$.extend({url:'ajax-ok.html',queryName:null,jsonp:null,item:'li',itemOverClass:'suggest-curr-item',sequential:0,delay:100,'z-index':999,processData:function(data){var template=[];template.push('<ul class="suggest-list">');var evenOdd={'0':'suggest-item-even','1':'suggest-item-odd'},count=0;for(var key in data){template.push('<li class="',evenOdd[(++count)%2],'">',key,'</li>')};template.push('</ul>');return template.join('')},getCurrItemValue:function($currItem){return $currItem.text()},textchange:function($input){},onselect:function($currItem){}},c);var ie=!-[1,],ie6=ie&&!window.XMLHttpRequest,CURRINPUT='suggest-curr-input',SUGGESTOVER='suggest-panel-overing',suggestShimId='suggest-shim-iframe',UP=38,DOWN=40,ESC=27,TAB=9,ENTER=13,CHANGE='input.suggest'/*@cc_on+' textchange.suggest'@*/,RESIZE='resize.suggest',BLUR='blur.suggest',KEYDOWN='keydown.suggest',KEYUP='keyup.suggest';return this.each(function(){var $t=$(this).attr('autocomplete','off');var hyphen=c.url.indexOf('?')!=-1?'&':"?";var URL=c.jsonp?[c.url,hyphen,c.jsonp,'=?'].join(''):c.url,CURRITEM=c.itemOverClass,$currItem=$(),sequentialTimeId=null;var $suggest=$(["<div style='position:absolute;zoom:1;z-index:",c['z-index'],"' class='auto-suggest-wrap'></div>"].join('')).appendTo('body');$suggest.bind({'mouseenter.suggest':function(e){$(this).addClass(SUGGESTOVER)},'mouseleave.suggest':function(){$(this).removeClass(SUGGESTOVER)},'click.suggest':function(e){var $item=$(e.target).closest(c.item);if($item.length){$t.val(c.getCurrItemValue($item));c.onselect($item);suggestClose()}},'mouseover.suggest':function(e){var $item=$(e.target).closest(c.item),currClass='.'+CURRITEM;if($item.length&&!$item.is(currClass)){$suggest.find(currClass).removeClass(CURRITEM);$currItem=$item.addClass(CURRITEM)}}});if(ie6){var $suggestShim=$('#'+suggestShimId);if(!$suggestShim.length){$suggestShim=$(["<iframe src='about:blank' style='position:absolute;filter:alpha(opacity=0);z-index:",c['z-index']-2,"' id='",suggestShimId,"'></iframe>"].join('')).appendTo('body')}};$(window).resize(function(){fixes()});function fixes(){var offset=$t.offset(),h=$t.innerHeight(),w=$t.innerWidth(),css={'top':offset.top+h,'left':offset.left,'width':w};$suggest.css(css);if(ie6){css['height']=$suggest.height();$suggestShim.css(css).show()}};function suggestClose(){$suggest.hide().removeClass(SUGGESTOVER);if(ie6){$suggestShim.hide()}};var selectBusy=false,triggerChange=true,dataExpired=false,keyHandler={'move':function(down){if(!$suggest.is(":visible"))return;if($currItem.length){$currItem.removeClass(CURRITEM);if(down){$currItem=$currItem.next()}else{$currItem=$currItem.prev()}}else{$currItem=$suggest.find(c.item+(down?':first':':last'))};if($currItem.length){$currItem.addClass(CURRITEM);$t.val($currItem.text())}else{$t.val($t.attr('curr-value'))};selectBusy=true},'select':function(){if($currItem.length){$t.val(c.getCurrItemValue($currItem));c.onselect($currItem)};suggestClose()}};var inputEvents={};inputEvents[KEYUP]=function(e){selectBusy=false;if(ie){var kc=e.keyCode;if(kc===UP||kc===DOWN||kc===TAB||kc===ENTER||kc===ESC){triggerChange=false}else{triggerChange=true}}};inputEvents[BLUR]=function(){if(!$suggest.hasClass(SUGGESTOVER)){suggestClose()}};inputEvents[KEYDOWN]=function(e){var kc=e.keyCode;if(kc===UP||kc===DOWN){if(!selectBusy){keyHandler.move(kc===DOWN);if(c.sequential){sequentialTimeId=setTimeout(function(){selectBusy=0},c.delay)}}}else if(kc===TAB||kc===ENTER){keyHandler.select(e);if(kc===ENTER)e.preventDefault()}else if(kc==ESC){$t.val($t.attr('curr-value'));suggestClose()}};inputEvents[CHANGE]=function(e){if(ie&&!triggerChange){return};var value=$.trim($t.val());if(value){$t.attr('curr-value',value);var param={},queryName=c.queryName?c.queryName:$t.attr('name');param[queryName]=value;dataExpired=false;$.getJSON(URL,param,function(data){if(dataExpired){return};if(data){$suggest.html(c.processData(data));fixes();$suggest.show();$currItem=$()}else{$suggest.hide()};dataExpired=true})}else{$suggest.hide()};c.textchange($t)};$t.bind(inputEvents)})}})(jQuery);